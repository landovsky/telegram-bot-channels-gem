<div class="mb-6">
  <h1 class="text-2xl font-bold text-gray-900">Events</h1>
  <p class="mt-1 text-sm text-gray-500"><%= @total_count %> total</p>
</div>

<div class="mb-6 bg-white shadow-sm rounded-lg border border-gray-200 p-6">
  <%= form_with url: telegram_bot_engine.admin_events_path, method: :get, local: true, class: "flex items-end space-x-4" do %>
    <div>
      <label for="type" class="block text-sm font-medium text-gray-700 mb-1">Event Type</label>
      <select name="type" id="type" class="block rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm px-3 py-2 border">
        <option value="">All</option>
        <% %w[command delivery auth_failure subscription_change].each do |t| %>
          <option value="<%= t %>" <%= "selected" if params[:type] == t %>><%= t %></option>
        <% end %>
      </select>
    </div>
    <div>
      <label for="action_name" class="block text-sm font-medium text-gray-700 mb-1">Action</label>
      <select name="action_name" id="action_name" class="block rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm px-3 py-2 border">
        <option value="">All</option>
        <% %w[start stop help broadcast notify delivered blocked failed unauthorized].each do |a| %>
          <option value="<%= a %>" <%= "selected" if params[:action_name] == a %>><%= a %></option>
        <% end %>
      </select>
    </div>
    <div>
      <label for="chat_id" class="block text-sm font-medium text-gray-700 mb-1">Chat ID</label>
      <input type="text" name="chat_id" id="chat_id" value="<%= params[:chat_id] %>"
             class="block rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm px-3 py-2 border"
             placeholder="e.g. 12345">
    </div>
    <div>
      <button type="submit"
              class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
        Filter
      </button>
    </div>
  <% end %>
</div>

<div class="bg-white shadow-sm rounded-lg border border-gray-200 overflow-hidden">
  <table class="min-w-full divide-y divide-gray-200">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Chat ID</th>
        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      <% @events.each do |event| %>
        <tr>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
            <%= event.created_at.strftime("%Y-%m-%d %H:%M:%S") %>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <%
              badge_colors = {
                "command" => "bg-blue-100 text-blue-800",
                "delivery" => "bg-green-100 text-green-800",
                "auth_failure" => "bg-red-100 text-red-800",
                "subscription_change" => "bg-yellow-100 text-yellow-800"
              }
              color = badge_colors[event.event_type] || "bg-gray-100 text-gray-800"
            %>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium <%= color %>">
              <%= event.event_type %>
            </span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            <%= event.action %>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
            <%= event.username || "-" %>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">
            <%= event.chat_id || "-" %>
          </td>
          <td class="px-6 py-4 text-sm text-gray-500 max-w-xs truncate" title="<%= event.details.to_json %>">
            <%= event.details.present? ? event.details.to_json.truncate(80) : "-" %>
          </td>
        </tr>
      <% end %>

      <% if @events.empty? %>
        <tr>
          <td colspan="6" class="px-6 py-12 text-center text-sm text-gray-500">
            No events found.
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
</div>

<% if @total_pages > 1 %>
  <div class="mt-4 flex justify-between items-center">
    <div class="text-sm text-gray-500">
      Page <%= @page %> of <%= @total_pages %>
    </div>
    <div class="flex space-x-2">
      <% if @page > 1 %>
        <%= link_to "Previous", telegram_bot_engine.admin_events_path(type: params[:type], action_name: params[:action_name], chat_id: params[:chat_id], page: @page - 1),
              class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" %>
      <% end %>
      <% if @page < @total_pages %>
        <%= link_to "Next", telegram_bot_engine.admin_events_path(type: params[:type], action_name: params[:action_name], chat_id: params[:chat_id], page: @page + 1),
              class: "inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50" %>
      <% end %>
    </div>
  </div>
<% end %>
